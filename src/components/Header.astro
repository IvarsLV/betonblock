---
import Button from './ui/Button.astro';

const BASE_URL = import.meta.env.BASE_URL;
---
<header class="fixed top-0 left-0 right-0 z-50 bg-white py-4 opacity-0 -translate-y-10 animate-slide-down transition-all duration-300">
  <nav class="container mx-auto flex justify-between items-center transition-all duration-300" aria-label="Galvenā navigācija" id="main-nav">
    <a href="/" class="focus:outline-none focus:ring-2 focus:ring-accent">
      <img src="/logo.png" alt="Betonblock Logo" class="max-h-20 transition-all duration-300" id="logo"/>
    </a>
    <div class="space-x-4">
      <nav>
        <button 
          id="hamburdeg-button" 
          class="text-3xl mr-auto focus:text-accent cursor-pointer md:hidden relative w-8 h-8"
          aria-label="Atvērt izvēlni"
          aria-expanded="false"
          aria-controls="mobile-menu"
        >
          <div class="bg-black w-6 h-0.5 rounded absolute top-4 -mt-0.5 
           transition-all duration-300
           before:content-[''] before:bg-black before:w-6 
           before:h-0.5 before:rounded before:absolute
           before:-translate-x-3 before:-translate-y-2 
           before:transition-all before:duration-300
           after:content-[''] after:bg-black after:w-6 
           after:h-0.5 after:rounded after:absolute
           after:-translate-x-3 after:translate-y-2
           after:transition-all after:duration-300 z-50"></div>
        </button>
        <ul class="md:flex space-x-10 hidden" role="menubar">
          <li role="none"><a href={BASE_URL + "/"} class="hover:text-hoverAccent transition-colors duration-300 focus:outline-none " role="menuitem">Sākums</a></li>
          <li role="none"><a href={BASE_URL + "/par-mums"} class="hover:text-hoverAccent transition-colors duration-300 focus:outline-none " role="menuitem">Par mums</a></li>
          <li role="none"><a href={BASE_URL + "/pakalpojumi"} class="hover:text-hoverAccent transition-colors duration-300 focus:outline-none  " role="menuitem">Pakalpojumi</a></li>
          <li role="none"><a href={BASE_URL + "/materiali"} class="hover:text-hoverAccent transition-colors duration-300 focus:outline-none  " role="menuitem">Materiāli</a></li>
          <li role="none"><a href={BASE_URL + "/kontakti"} class="hover:text-hoverAccent transition-colors duration-300 focus:outline-none  " role="menuitem">Kontakti</a></li>
        </ul>
      </nav>
    </div>
  </nav>
</header>

<nav 
  id="mobile-menu" 
  class="fixed inset-0 bg-white/95 backdrop-blur-sm transform transition-all duration-300 ease-in-out translate-x-full md:hidden z-50"
  aria-label="Mobilā izvēlne"
>
  <button 
    class="fixed top-6 right-6 p-2 hover:bg-accent/10 rounded-full transition-colors duration-300 z-50"
    onclick="document.getElementById('hamburdeg-button').click()"
    aria-label="Aizvērt izvēlni"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  </button>

  <div class="container mx-auto px-4 h-screen flex flex-col">
    <div class="flex justify-between items-center py-8">
      <span class="text-2xl text-accent font-medium">Izvēlne</span>
    </div>
    <div class="flex-1 overflow-y-auto py-8">
      <ul class="flex flex-col items-stretch justify-start space-y-2" role="menu">
        <li role="none" class="border-b border-gray-100">
          <a href={BASE_URL + "/"} 
            class="block w-full text-center py-8 text-3xl font-medium hover:text-accent transition-colors duration-300 hover:bg-accent/5" 
            role="menuitem">Sākums</a>
        </li>
        <li role="none" class="border-b border-gray-100">
          <a href={BASE_URL + "/par-mums"} 
            class="block w-full text-center py-8 text-3xl font-medium hover:text-accent transition-colors duration-300 hover:bg-accent/5" 
            role="menuitem">Par mums</a>
        </li>
        <li role="none" class="border-b border-gray-100">
          <a href={BASE_URL + "/pakalpojumi"} 
            class="block w-full text-center py-8 text-3xl font-medium hover:text-accent transition-colors duration-300 hover:bg-accent/5" 
            role="menuitem">Pakalpojumi</a>
        </li>
        <li role="none" class="border-b border-gray-100">
          <a href={BASE_URL + "/materiali"} 
            class="block w-full text-center py-8 text-3xl font-medium hover:text-accent transition-colors duration-300 hover:bg-accent/5" 
            role="menuitem">Materiāli</a>
        </li>
        <li role="none" class="border-b border-gray-100">
          <a href={BASE_URL + "/kontakti"} 
            class="block w-full text-center py-8 text-3xl font-medium hover:text-accent transition-colors duration-300 hover:bg-accent/5" 
            role="menuitem">Kontakti</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<style>
  /* Анимация для мобильного меню */
  #mobile-menu {
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease-in-out;
  }

  #mobile-menu.flex {
    opacity: 1;
    pointer-events: auto;
    transform: translateX(0);
  }

  /* Стили для мобильного меню */
  #mobile-menu ul li a {
    position: relative;
  }

  #mobile-menu ul li a::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 0;
    height: 2px;
    background-color: var(--color-accent);
    transition: all 0.3s ease;
    transform: translateX(-50%);
  }

  #mobile-menu ul li a:hover::after {
    width: 30%;
  }

  /* Анимация появления хедера */
  .animate-slide-down {
    animation: slideDown 0.5s ease forwards;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-2.5rem);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script define:vars={{ BASE_URL }}>
  const pageTitles = {
    'par-mums': 'Par mums | Betonblock SIA',
    'pakalpojumi': 'Pakalpojumi | Betonblock SIA',
    'materiali': 'Materiāli | Betonblock SIA',
    'kontakti': 'Kontakti | Betonblock SIA',
    'home': 'Betonblock SIA'
  };

  function updateTitle(sectionId) {
    document.title = pageTitles[sectionId] || pageTitles.home;
  }

  function scrollToSection(sectionId) {
  const section = document.getElementById(sectionId);
  if (section) {
    const header = document.querySelector('header');
    const headerHeight = header ? header.offsetHeight : 0;
    const sectionPosition = section.getBoundingClientRect().top + window.scrollY;
    const extraPadding = 20;

    window.scrollTo({
      top: sectionPosition - headerHeight - extraPadding,
      behavior: 'smooth'
    });

    history.pushState({}, '', `/#${sectionId}`); // Без BASE_URL
    updateTitle(sectionId);
  }
}

  function scrollToTop() {
    window.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
    window.history.pushState({}, '', BASE_URL + '/');
    updateTitle('home');
  }

  const initApp = () => {
    const hamburgerButton = document.getElementById('hamburdeg-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const desktopLinks = document.querySelectorAll('.md\\:flex a[href^="' + BASE_URL + '"]');
    const mobileLinks = document.querySelectorAll('#mobile-menu a[href^="' + BASE_URL + '"]');

    if (!hamburgerButton || !mobileMenu) return;

    let isMenuOpen = false;

    const handleInitialUrl = () => {
      const path = window.location.pathname;
      if (path !== BASE_URL + '/') {
        const sectionId = path.replace(BASE_URL + '/', '');
        setTimeout(() => {
          scrollToSection(sectionId);
          updateTitle(sectionId);
        }, 100);
      } else {
        updateTitle('home');
      }
    };

    const toggleMenu = () => {
      isMenuOpen = !isMenuOpen;
      mobileMenu.classList.toggle('flex');
      hamburgerButton.classList.toggle('toggle-btn');
      hamburgerButton.setAttribute('aria-expanded', isMenuOpen.toString());
      hamburgerButton.setAttribute('aria-label', isMenuOpen ? 'Aizvērt izvēlni' : 'Atvērt izvēlni');
      document.body.classList.toggle('overflow-hidden');
    }

    const closeMenu = () => {
      if (isMenuOpen) {
        isMenuOpen = false;
        mobileMenu.classList.remove('flex');
        hamburgerButton.classList.remove('toggle-btn');
        hamburgerButton.setAttribute('aria-expanded', 'false');
        hamburgerButton.setAttribute('aria-label', 'Atvērt izvēlni');
        document.body.classList.remove('overflow-hidden');
      }
    }

    hamburgerButton.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleMenu();
    });

    desktopLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const href = link.getAttribute('href');
        if (href === BASE_URL + '/') {
          scrollToTop();
          return;
        }
        const sectionId = href?.replace(BASE_URL + '/', '');
        if (sectionId) {
          scrollToSection(sectionId);
        }
      });
    });

    mobileLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const href = link.getAttribute('href');
        if (href === BASE_URL + '/') {
          closeMenu();
          setTimeout(() => scrollToTop(), 300);
          return;
        }
        const sectionId = href?.replace(BASE_URL + '/', '');
        if (sectionId) {
          closeMenu();
          setTimeout(() => scrollToSection(sectionId), 300);
        }
      });
    });

    window.addEventListener('popstate', () => {
      const path = window.location.pathname;
      if (path === BASE_URL + '/') {
        scrollToTop();
        updateTitle('home');
      } else {
        const sectionId = path.replace(BASE_URL + '/', '');
        scrollToSection(sectionId);
        updateTitle(sectionId);
      }
    });

    document.addEventListener('click', (e) => {
      if (!isMenuOpen) return;
      const target = e.target;
      if (!mobileMenu.contains(target) && !hamburgerButton.contains(target)) {
        closeMenu();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isMenuOpen) {
        closeMenu();
      }
    });

    handleInitialUrl();
  }

  document.addEventListener('DOMContentLoaded', initApp);

  document.addEventListener('DOMContentLoaded', () => {
    const header = document.querySelector('header');
    const nav = document.getElementById('main-nav');
    const logo = document.getElementById('logo');

    if (!header || !nav || !logo) return;

    let lastScroll = 0;

    window.addEventListener('scroll', () => {
      const currentScroll = window.pageYOffset;

      if (currentScroll > 50) {
        header.classList.add('py-0.5', 'shadow-sm');
        header.classList.remove('py-4');
        nav.classList.add('py-0.5');
        logo.style.maxHeight = '40px';
      } else {
        header.classList.remove('py-0.5', 'shadow-sm');
        header.classList.add('py-4');
        nav.classList.remove('py-0.5');
        logo.style.maxHeight = '80px';
      }

      lastScroll = currentScroll;
    });
  });
</script>